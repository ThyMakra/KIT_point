{% extends "base_site.html" %}

{% block content %}
  <div class="right_col" role="main">    
    <div class="">
      <div class="row">
        <div class="col-xs-12" id="alert_message">
          {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
              {% for category, message in messages %}
                {% if category == 'success' %}
                  <ul class="alert alert-success">                
                    <label>{{ message }}</label>                
                  </ul>
                {% elif category == 'error' %}
                  <ul class="alert alert-error">
                    <label>{{ message }}</label>                
                  </ul>
                {% endif %}
              {% endfor %}
            {% endif %}
          {% endwith %}
          {% if error %}
            <p class="alert alert-error"><strong>Error:</strong> {{ error }}
          {% endif %}
          <div class="x_panel">
            <div class="x_title">
              <h2>Update Form
                <small>Click to validate</small>
              </h2>
              <ul class="nav navbar-right panel_toolbox">
                <li><a class="collapse-link"><i class="fa fa-chevron-up"></i></a></li>
                <li><a href="/company"><i class="fa fa-list-alt"></i></a></li>
                <li class="dropdown">
                  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false"><i
                    class="fa fa-wrench"></i></a>
                  <ul class="dropdown-menu" role="menu">
                    <li><a href="#" id="save_company">Save</a></li>
                    <li><a href="#">Move to complete</a></li>
                  </ul>
                </li>
                <li><a class="close-link"><i class="fa fa-close"></i></a>
                </li>
              </ul>
              <div class="clearfix"></div>
            </div>
            
            <!-- Member pop-up modal -->
            <div class="modal fade bs-example-modal-sm" id="member_modal" tabindex="-1" role="dialog" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                  <div class="modal-content">                    
                    <div class="modal-header">
                      <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                        aria-hidden="true"> x </span>
                      </button>
                      <h4 class="modal-title" id="myModalLabel2">Members</h4>
                      </div>
                      <div class="modal-body" style="overflow: hidden">
                      <form id="member-form" action="{{ url_for('company_blueprint.update_adding_members', company_id=company.id) }}" data-parsley-validate method="post">
                        {% for field in update_member_form if field.label.text == 'Members' %}
                          <div class="col-md-6 col-sm-6 col-sx-12 form-group">
                              <label>{{ field.label.text }}</label>
                              {{ field(class="select2_multiple form-control required", multiple="multiple", placeholder=field.label.text) }}
                          </div>
                        {% endfor %}
                      </form>
                    </div>                    
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        <button type="submit" form="member-form" class="btn btn-primary">Save changes</button>
                    </div>
                </div>
              </div>
            </div>

            <!-- Vice president pop-up modal -->
            <div class="modal fade bs-example-modal-sm" id="vice_president_modal" tabindex="-1" role="dialog" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                  <div class="modal-content">                    
                    <div class="modal-header">
                      <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                        aria-hidden="true"> x </span>
                      </button>
                      <h4 class="modal-title" id="myModalLabel3">Vice President</h4>
                      </div>
                      <div class="modal-body" style="overflow: hidden">
                      <form id="vice_president-form" action="{{ url_for('company_blueprint.update_adding_vice_presidents', company_id=company.id) }}" data-parsley-validate method="post">
                        {% for field in update_vice_president_form if field.label.text == 'Vice President' %}
                          <div class="col-md-6 col-sm-6 col-sx-12 form-group">
                              <label>{{ field.label.text }}</label>
                              {{ field(class="select2_multiple form-control required", multiple="multiple", placeholder=field.label.text) }}
                          </div>
                        {% endfor %}
                      </form>
                    </div>                    
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        <button type="submit" form="vice_president-form" class="btn btn-primary">Save changes</button>
                    </div>
                </div>
              </div>
            </div>
            
            <div class="x_content">

              <!-- start form for validation -->
              <form id="demo-form" data-parsley-validate method="post">
                {% for field in form if field.widget.input_type != 'hidden' %}
                  {% if field.label.text == 'Technical Adviser' or field.label.text == 'Vice President' or field.label.text == 'A2A Staff' %}
                    <div class="col-md-6 col-sm-6 col-sx-12 form-group">
                      <label>{{ field.label.text }}</label>
                      {{ field(class="select2_multiple form-control required", multiple="multiple", placeholder=field.label.text) }}
                    </div>
                    {% elif field.label.text == 'Chairman' %}
                    <div class="col-md-6 col-sm-6 col-sx-12 form-group has-feedback">
                      <label>{{ field.label.text }}</label>
                      {{ field(class="form-control has-feedback-left", placeholder=field.label.text) }}
                      <span class="fa fa-edit form-control-feedback left" aria-hidden="true"></span>
                    </div>
                  {% else %}
                    <div class="col-md-3 col-sm-3 col-xs-12 form-group has-feedback">
                      <label>{{ field.label.text }}</label>
                      {% if field.label.text == 'Name' %}
                        {{ field(class="form-control has-feedback-left required", placeholder=field.label.text) }}
                        <span class="fa fa-pencil-square form-control-feedback left" aria-hidden="true"></span>
                      {% elif field.label.text == 'Code' %}
                        {{ field(class="form-control has-feedback-left required", placeholder=field.label.text) }}
                        <span class="fa fa-code form-control-feedback left" aria-hidden="true"></span>
                      {% elif field.label.text == 'Description' %}
                        {{ field(class="form-control has-feedback-left required", placeholder=field.label.text) }}
                        <span class="fa fa-edit form-control-feedback left" aria-hidden="true"></span>                      
                      {% elif field.label.text == 'President' %}
                        {{ field(class="form-control has-feedback-left required", placeholder=field.label.text) }}
                        <span class="fa fa-user form-control-feedback left" aria-hidden="true"></span>                      
                      {% elif field.label.text == 'Established Date' %}
                        {{ field(class="form-control has-feedback-left required custom-date-picker", placeholder=field.label.text) }}
                        <span class="fa fa-calendar form-control-feedback left" aria-hidden="true"></span>                      
                      {% else %}
                        {{ field(class="form-control has-feedback-left", placeholder=field.label.text) }}
                        <span class="fa fa-star form-control-feedback left" aria-hidden="true"></span>
                      {% endif %}
                    </div>
                  {% endif %}
                {% endfor %}
                <input type="submit" id="submit" hidden="hidden">
              </form>
              <!-- end form for validations -->
                            

              <!-- table panel -->
              <div class="x_content">                
                <div class="" role="tabpanel" data-example-id="togglable-tabs">
                    <ul id="myTab" class="nav nav-tabs bar_tabs" role="tablist">
                      <li role="presentation" class="active"><a href="#tab_content1" id="active_member-tab" role="tab" data-toggle="tab" aria-expanded="true"> Active Members </a>
                      </li>
                      <li role="presentation" class=""><a href="#tab_content2" role="tab" id="inactive_member-tab" data-toggle="tab" aria-expanded="false"> Inactive Members  </a>
                      </li>
                      <li role="presentation" class=""><a href="#tab_content3" role="tab" id="project-tab" data-toggle="tab" aria-expanded="false"> Project  </a>
                      </li>
                    </ul>
                  <div id="myTabContent" class="tab-content">
                    <div role="tabpanel" class="tab-pane fade active in" id="tab_content1" aria-labelledby="active_member-tab">
                      
                      <!-- button that call the modal -->
                      <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#member_modal">
                          + Add member
                      </button>

                      <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#vice_president_modal">
                          Add/Remove vice president
                      </button>

                      <table id="active_member-datatable"
                             class="table table-striped table-bordered table-hover dt-responsive nowrap" cellspacing="0"
                             width="100%">
                        <thead>
                          <tr>
                            <th>Name</th>
                            <th>Role</th>
                            <th>Roll Number</th>                            
                            <th>Gender</th>                            
                            <th>Batch</th>                            
                            <th style="width: 10%">Status</th>
                            <th style="width: 10%">Change Status</th>
                          </tr>
                        </thead>
                        <tbody>
                        {% for member in company.members %}          
                          <tr>
                            <td>{{ member.name }}</td>
                            <td>{% if member.id == company.president_id %}President{% elif member in company.vice_president %}Vice President{% else %}Member{% endif %}</td>
                            <td>{{ member.roll_number }}</td>
                            <td>{{ member.gender }}</td>
                            <td>{{ member.batch }}</td>
                            <td>Active</td>
                            <td><a href="company{{ company.id }}/change_to_inactive{{ member.id }}" class="btn btn-info btn-xs"><i class="fa fa-rotate-right"></i> Change </a></td>
                          </tr>
                        {% endfor %}
                        </tbody>
                      </table>
                    </div>

                    <div role="tabpanel" class="tab-pane fade" id="tab_content2" aria-labelledby="inactive_member-tab">

                      <table id="inactive_member-datatable"
                             class="table table-striped table-bordered table-hover dt-responsive nowrap" cellspacing="0"
                             width="100%">
                        <thead>
                          <tr>
                            <th>Name</th>
                            <th>Role</th>
                            <th>Roll Number</th>                            
                            <th>Gender</th>                            
                            <th>Batch</th>                            
                            <th style="width: 10%">Status</th>
                            <th style="width: 10%">Change Status</th>                            
                          </tr>
                        </thead>
                        <tbody>
                        {% for member in company.inactive_members %}
                          <tr>
                            <td>{{ member.name }}</td>
                            <td>{% for i in member.inactive if i.company_id == company.id %}{{ i.role }}{% endfor %}</td>
                            <td>{{ member.roll_number }}</td>
                            <td>{{ member.gender }}</td>
                            <td>{{ member.batch }}</td>
                            <td>Inactive</td>
                            <td><a href="company{{ company.id }}/change_to_active{{ member.id }}" class="btn btn-info btn-xs"><i class="fa fa-rotate-right"></i> Change </a></td>                            
                          </tr>
                        {% endfor %}
                        </tbody>
                      </table>
                    </div>            
                    
                    <div role="tabpanel" class="tab-pane fade" id="tab_content3" aria-labelledby="project-tab">
                        <table id="project-datatable"
                           class="table table-striped table-bordered table-hover dt-responsive nowrap" cellspacing="0"
                           width="100%">
                          <thead>
                          <tr>
                            <th>Name</th>
                            <th>Status</th>
                            <th>Company</th>
                            <th>Estimate</th>
                            <th>Actual</th>
                            <th>Propose</th>
                            <th>Acquire</th>
                            <th>Start Date</th>
                            <th>Deadline</th>
                            <th>End date</th>
                            <th>Next action</th>
                            <th>Edit</th>
                          </tr>
                          </thead>

                          <tbody>
                          {% for project in company.projects %}
                            <tr>
                              <td>{{ project.name }}</td>
                              <td>{{ project.status }}</td>
                              <td>{{ project.company}}</td>
                              <td>{{ project.estimate_point }}</td>
                              <td>{{ project.actual_point }}</td>
                              <td>{{ project.propose_point }}</td>
                              <td>{{ project.acquire_point }}</td>
                              <td>{{ project.start_date }}</td>
                              <td>{{ project.deadline }}</td>
                              <td>
                                {% if project.end_date != None %}
                                  {{ project.end_date }}
                                {% else %}
                                  <p></p>
                                {% endif %}
                              </td>
                              <td>
                                {% if project.status.name == "In Progress" %}
                                  <a class="btn btn-success btn-xs" href="#">Complete</a>
                                {% elif project.status.name == 'Complete' %}
                                  <a class="btn btn-info btn-xs" href="#">Request point</a>
                                {% elif project.status.name == 'Point to approve' %}
                                  <a class="btn btn-primary btn-xs" href="#">Yes</a>
                                  <a class="btn btn-danger btn-xs" href="#">No</a>
                                {% elif project.status.name == 'Project to approve' %}
                                  <a class="btn btn-primary btn-xs" href="#">Yes</a>
                                  <a class="btn btn-danger btn-xs" href="#">No</a>
                                {% else %}
                                  <p></p>
                                {% endif %}
                              </td>
                              <td>
                                <a href="#" class="btn btn-primary btn-xs"><i class="fa fa-folder"></i> View </a>
                                <a href="/project/{{ project.id }}" class="btn btn-info btn-xs"><i class="fa fa-pencil"></i>
                                  Edit </a>
                                <a href="/project/delete{{ project.id }}" class="btn btn-danger btn-xs"><i
                                  class="fa fa-trash-o"></i> Delete </a>
                              </td>
                            </tr>
                          {% endfor %}
                          </tbody>
                        </table>
                    </div>
                  </div>
                </div>                
              </div>                        
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

{% endblock content %}
{% block javascripts %}
  {{ super() }}
  {#  <!-- Parsley -->#}  
  <script src="{{ url_for('static', filename='vendors/parsleyjs/dist/parsley.min.js') }}"></script>
  <script src="{{ url_for('static', filename='vendors/select2/dist/js/select2.full.min.js') }}"></script>
  <script src="{{ url_for('static', filename='vendors/select2/dist/js/select2.min.js') }}"></script>
  <script src="{{ url_for('static', filename='build/js/date-picker.js') }}"></script>
  <script type="text/javascript">
    let members = [];
    let advisers = [];
    let vice_presidents = [];
    let a2a_staffs = [];
    let all_active = [];       
            
    let $member = $('#member');
    let $adviser = $('#adviser');
    let $vice_president = $('#vice_president');
    let $a2a_staff = $('#a2a_staff');

    {% for adviser in company.advisers %}
      advisers.push({{ adviser.id }});
    {% endfor %}    
    {% for vice_president in company.vice_president %}
      vice_presidents.push({{ vice_president.id }});
    {% endfor %}
    {% for a2a_staff in company.a2a_staff %}
      a2a_staffs.push({{ a2a_staff.id }});
    {% endfor %}
    {% for member in company.members %}    
      members.push({{ member.id }});       
    {% endfor %}
    // get all the active members from different company, except this company active member
    {% for is_active in active_members %}
      all_active.push({{ is_active.student_id }});
    {% endfor %}
    all_active = all_active.filter(x => members.indexOf(x) < 0);
    
    $member.select2({        
        placeholder: 'Select a member',
        allowClear: true,
        width: '200%',      
    });
    
    $(document).ready(function() {
      $('#name').val('{{ company.name }}');      
      $('#code').val('{{ company.code }}');
      $('#description').val('{{ company.description }}');
      $('#chairman').val('{{ company.chairman_id }}');
      $('#president').val('{{ company.president_id }}');      
      let president = $('#president').val();

      
      $adviser.select2({
        placeholder: 'Select a adviser',
        allowClear: true,
      });
      $vice_president.select2({
        placeholder: 'Select a vice president',
        allowClear: true,
        width: '200%',
      });
      $a2a_staff.select2({
        placeholder: 'Select an A2A staff',
        allowClear: true,
      });      
      $('#save_company').on('click', function() {
        $('#submit').trigger('click');
      });      
      $adviser.val(advisers);
      $adviser.trigger('change');
      $vice_president.val(vice_presidents);
      $vice_president.trigger('change');
      $a2a_staff.val(a2a_staffs);
      $a2a_staff.trigger('change');      
      $(document).ready(function() {
        $('.custom-date-picker').daterangepicker({
          singleDatePicker: true,
          singleClasses: "picker_1"
        });
      });
      $('#president').on('change', function(e){
        let member = $('#member').val();
        let vice_president = $('#vice_president').val();
        let selected_president = $(this).val();  
        // check if already active in other company
        if (all_active != null && all_active.includes(parseInt(selected_president))){                    
          {% for is_active in active_members %}
            if ({{ is_active.student_id }} == parseInt(selected_president)){                                
              alertify.notify('Already active in {{ is_active.company }}', 'error', 5);                
            }
          {% endfor %}
          $(this).val(president).trigger('change');
        }
        // check if already selected as a vice president
        if(vice_president != null && vice_president.includes(selected_president)){                    
          alertify.notify('Already selected as vice president', 'error', 5);          
          $(this).val(president).trigger('change');
        }        
      });
    });
  $(document).ready(function() {
  // selecting vice president
  $('#vice_president').on('select2:selecting', function(e){  
    let vice_president = e.params.args.data.id;
    let president = $('#president').val();
    let member = $('#member').val();
    // check if is the president
    if (vice_president == president){
      alertify.notify('Already assigned as leader.', 'error', 5);
      e.preventDefault();
    }      
    // check if already active
    else if (all_active != null && all_active.includes(parseInt(vice_president))){        
      {% for is_active in active_members %}
        if ({{ is_active.student_id }} == parseInt(vice_president)){
          alertify.notify('Already active in {{ is_active.company }}', 'error', 5);                
        }
      {% endfor %}
      e.preventDefault();
      }
  });
  // selecting members
  $('#member').on('select2:selecting', function(e){
    let member = e.params.args.data.id;
    let president = $('#president').val();
    let vice_president = $('#vice_president').val();      
    // check if is the president
    if (member == president){        
      alertify.notify('Already assigned as leader.', 'error', 5);
      e.preventDefault();
    }
    // check if in vice presidents list      
    else if (vice_president != null && vice_president.includes(member)){        
      alertify.notify('Already assigned as vice president.', 'error', 5);
      e.preventDefault();
    }
    // check if already active
    else if (all_active != null && all_active.includes(parseInt(member))){        
      // get the company
        {% for is_active in active_members %}
          if ({{ is_active.student_id }} == parseInt(member)){
            alertify.notify('Already active in {{ is_active.company }}', 'error', 5);                
          }
        {% endfor %}
        e.preventDefault();        
    }
    else if (members.includes(parseInt(member))){
      alertify.notify('Already an existing member', 'warning', 5)
      e.preventDefault();
    }
  });
});
 
  </script> 
{% endblock javascripts %}
